{% extends "base.html" %}
{% load humanize %}
{% load django_tables2 %}
{% block title %}Finance - Solinor{% endblock %}

{% block pageJs %}
$.get("{% url "your_stats" %}", function(data) {
  if (data.your_unsubmitted_entries > 0) {
    $("#your_unsubmitted_entries").addClass("text-danger");
    $("#your_unsubmitted_entries").html(data.your_unsubmitted_entries + " <i class='fa fa-exclamation-circle'></i>");
  } else {
    $("#your_unsubmitted_entries").html(data.your_unsubmitted_entries + " <i class='fa fa-check-circle'></i>");
  }
  $("#your_last_hour_marking").html(data.your_last_hour_marking + " (" + data.your_last_hour_marking_day + ")");
  if (typeof data.your_hours_this_week === "number") {
    $("#your_hours_this_week").html(data.your_hours_this_week.toFixed(2) + "h");
  } else {
    $("#your_hours_this_week").html("?");
  }
  if (typeof data.your_billing_ratio === "number") {
    $("#your_billing_ratio").html(data.your_billing_ratio.toFixed(0) + "%");
  } else {
    $("#your_billing_ratio").html("?");
  }
  $("#your_billing_ratio_sparkline").sparkline(data.your_daily_billing_ratio, {"disableTooltips": true});
});
$(".sparkline-inline-content").sparkline('html', {"width": "100%", "type": "bar", "disableTooltips": true});
{% endblock %}
{% block content %}

<h3>Your information</h3>

<div class="row">
  <div class="col-md-3 clickable-area" onclick="Turbolinks.visit('{% url "your_unsubmitted_hours" %}');">
    <div class="card your-information-card">
      <div class="card-body">
        <h5 class="card-title">Unsubmitted entries</h5>
        <p class="lead" id="your_unsubmitted_entries">Loading</p>
        </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card your-information-card">
      <div class="card-body">
        <h5 class="card-title">Last hour marking</h5>
        <p class="lead" id="your_last_hour_marking">Loading</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card your-information-card">
      <div class="card-body">
        <h5 class="card-title">Hours for past 7 days</h3>
        <p class="lead" id="your_hours_this_week">Loading</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card your-information-card">
      <div class="card-body">
        <h5 class="card-title">Your billing rate <small>Past 30d</small></h3>
        <p class="lead"><span id="your_billing_ratio">Loading</span> <span id="your_billing_ratio_sparkline"></span></p>
      </div>
    </div>
  </div>
</div>

{% if your_invoices %}
<h3 style="margin-top: 1em">Your projects</h3>

{% include "snippets/frontpage_table.html" with invoices=your_invoices %}

{% endif %}

<h3 style="margin-top: 1em">Our current projects</h3>

<p class="text-muted">Sort <a href="?sorting=alphabetically">alphabetically</a>, <a href="?sorting=billing">by billing</a>, <a href="?sorting=hours">by amount of hours</a></p>

<div class="album py-5 bg-light">
  <div class="container-fluid">
    <div class="row">
      {% for card in cards %}
      <div class="project-card-container mx-auto">
        <div class="card mb-4 box-shadow">
          <span class="clickable-area project-card-image" onclick="Turbolinks.visit('{% url "project" card.project.guid %}')">
            <img class="card-img-top" src="{{ card.project.thumbnail_url }}">
          </span>
          <div class="card-header clickable-area project-card-title" onclick="Turbolinks.visit('{% url "project" card.project.guid %}')"><h5>{{ card.project }}</h5></div>
          <div class="card-body">
            <p class="card-text">
              <p class="project-card-description" data-toggle="popover" title="Description" data-content="{{ card.project.description }}">{{ card.project.description }}</p> {% comment %}TODO: this will break when there is quotes in project.description{% endcomment %}
              <div class="row">
                <div class="col-md-12"><h6 data-toggle="tooltip" data-placement="top" title="Billing for previous and current months."><p class="text-floating-left">Billing</p><p class="text-floating-right">{{ card.money_sum|floatformat:"0"|intcomma }}€</p></h6></div>
                <div class="col-md-12" style="text-align: center"><span class="sparkline-inline-content">{% for value in card.money %}{{ value }}{% if not forloop.last %},{% endif %}{% endfor %}</span></div>
              </div>
              <div class="row">
                <div class="col-md-12"><h6 data-toggle="tooltip" data-placement="top" title="Incurred hours for previous and current months."><p class="text-floating-left">Hours</p><p class="text-floating-right">{{ card.hours_sum|floatformat:"0"|intcomma }}h</p></h6></div>
                <div class="col-md-12" style="text-align: center"><span class="sparkline-inline-content">{% for value in card.hours %}{{ value }}{% if not forloop.last %},{% endif %}{% endfor %}</span></div>
              </div>
              <div class="row">
                <div class="col-md-12"><h6 data-toggle="tooltip" data-placement="top" title="Average number of people working on the project on weekdays during previous and current months."><p class="text-floating-left">People</p><p class="text-floating-right">{{ card.people_avg|floatformat:"1" }} per weekday</p></h6></div>
                <div class="col-md-12" style="text-align: center"><span class="sparkline-inline-content">{% for value in card.people %}{{ value }}{% if not forloop.last %},{% endif %}{% endfor %}</span></div>
              </div>
            </p>
            <div class="d-flex justify-content-between align-items-center">
              <div class="btn-group">
                <a href="https://app.10000ft.com/viewproject?id={{ card.project.project_id }}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-secondary">10000ft</a>
                <a href="{% url "project" card.project.guid %}" class="btn btn-sm btn-outline-secondary">View</a>
              </div>
              <small class="text-muted"></small>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}
