{% extends "base.html" %}
{% load humanize %}
{% load django_tables2 %}
{% block title %}Finance - Solinor{% endblock %}

{% block pageJs %}
$.get("{% url "your_stats" %}", function(data) {
  if (data.your_unsubmitted_entries > 0) {
    $("#your_unsubmitted_entries").addClass("text-danger");
    $("#your_unsubmitted_entries").html(data.your_unsubmitted_entries + " <span class='glyphicon glyphicon-exclamation-sign'></span>");
  } else {
    $("#your_unsubmitted_entries").html(data.your_unsubmitted_entries + " <span class='glyphicon glyphicon-ok-sign'>");
  }
  $("#your_last_hour_marking").html(data.your_last_hour_marking + " (" + data.your_last_hour_marking_day + ")");
  if (typeof data.your_hours_this_week === "number") {
    $("#your_hours_this_week").html(data.your_hours_this_week.toFixed(2) + "h");
  } else {
    $("#your_hours_this_week").html("?");
  }
  if (typeof data.your_billing_rate === "number") {
    $("#your_billing_rate").html(data.your_billing_rate.toFixed(0) + "%");
  } else {
    $("#your_billing_rate").html("?");
  }
})

{% endblock %}
{% block content %}

<div class="row well">
  <div class="col-md-3 clickable-area" onclick="Turbolinks.visit('{% url "your_unsubmitted_hours" %}');">
    <h3>Unsubmitted entries</h3>
    <p class="lead" id="your_unsubmitted_entries">Loading</p>
  </div>
  <div class="col-md-3">
    <h3>Last hour marking</h3>
    <p class="lead" id="your_last_hour_marking">Loading</p>
  </div>
  <div class="col-md-3">
    <h3>Hours for past 7 days</h3>
    <p class="lead" id="your_hours_this_week">Loading</p>
  </div>
  <div class="col-md-3">
    <h3>Your billing rate <small>Past 30d</small></h3>
    <p class="lead" id="your_billing_rate">Loading</p>
  </div>
</div>


{% if your_invoices %}
<h2>Your projects</h2>

{% include "snippets/frontpage_table.html" with invoices=your_invoices %}

{% endif %}
<h2>All invoices <small><span data-toggle="collapse" data-target="#invoice-table-filters"><span class="glyphicon glyphicon-filter"></span></span></small>
  <span class="text-right">
  <form method="post" class="form-inline" action="{% url "queue_update" %}">
    {% csrf_token %}
    <input type="hidden" name="back" value="{{ request.get_full_path }}">
    <button role="submit" name="Request data update" class="btn btn-default">Request data update (last update finished {{ last_update_finished_at|naturaltime }})</button>
  </form>
  </span></h2>

<div id="invoice-table-filters" class="collapse">
<form action="" method="get" class="form-inline">
  <div class="row">
  {% for field in filters.form %}
  <div class="col-md-3">
    <h4>{{Â field.label_tag }}</h4>
    <p class="list-group-item-text">{{ field }}</p>
  </div>
  {% endfor %}
  </div>
  <button class="btn btn-primary" type="submit">Filter</button>
</form>
</div>

{% render_table invoices %}

{% endblock %}
